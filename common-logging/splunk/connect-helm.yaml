apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: splunk-connect
  namespace: splunk
spec:
  interval: 6h
  install:
    crds: CreateReplace
  upgrade:
    crds: CreateReplace
  chart:
    spec:
      chart: splunk-connect-for-kubernetes
      version: 1.5.0
      sourceRef:
        kind: HelmRepository
        name: splunk-connect
        namespace: flux-system
  valuesFrom:
    - kind: Secret
      name: beryjuorg-splunk-hec
  values:
    global:
      logLevel: info
      splunk:
        hec:
          host: splunk-collector.infra.beryju.org
          port: 443
          protocol: https
          indexName: kubernetes
      kubernetes:
        clusterName: "${CLUSTER_NAME}"
      serviceMonitor:
        enabled: true
    splunk-kubernetes-logging:
      enabled: true
      customFilters:
        kubernetes_fixed:
          tag: tail.containers.**
          type: kubernetes_metadata
          body: |
            annotation_match [ ".*" ]
            de_dot false
            watch true
            cache_ttl 3600
            ssl_partial_chain true
      k8sMetadata:
        podLabels:
          - app
          - k8s-app
          - release
          - app.kubernetes.io/component
          - app.kubernetes.io/name
          - app.kubernetes.io/version
          - app.kubernetes.io/instance
        watch: true
      containers:
        logFormatType: "${CLUSTER_CONTAINER_LOG_TYPE:=json}"
      tolerations:
        - effect: NoExecute
          operator: Exists
        - effect: NoSchedule
          operator: Exists
    splunk-kubernetes-objects:
      enabled: false
    splunk-kubernetes-metrics:
      enabled: false
