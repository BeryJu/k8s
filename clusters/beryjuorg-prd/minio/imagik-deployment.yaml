apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/name: imagik
  name: imagik
  namespace: minio
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: imagik
  template:
    metadata:
      labels:
        app.kubernetes.io/name: imagik
    spec:
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/name
                    operator: In
                    values:
                      - minio
              topologyKey: kubernetes.io/hostname
      containers:
        - command:
            - /imagik
            - -c=/config.yml
          envFrom:
            - configMapRef:
                name: imagik-config
          image: ghcr.io/beryju/imagik:latest-1641202539-df9e937f3d2e5d78d8e52cbe7d5fa42b9d6347f3 # {"$imagepolicy": "flux-system:imagik"}
          imagePullPolicy: IfNotPresent
          livenessProbe:
            httpGet:
              path: /api/pub/health/liveness
              port: http
              scheme: HTTP
          name: imagik
          ports:
            - containerPort: 8000
              name: http
              protocol: TCP
            - containerPort: 9300
              name: http-metrics
              protocol: TCP
          readinessProbe:
            httpGet:
              path: /api/pub/health/readiness
              port: http
              scheme: HTTP
          resources:
            limits:
              cpu: 500m
              memory: 250M
            requests:
              cpu: 10m
              memory: 10M
          volumeMounts:
            - mountPath: /data
              name: storage
      volumes:
        - name: storage
          persistentVolumeClaim:
            claimName: minio-pv-claim
