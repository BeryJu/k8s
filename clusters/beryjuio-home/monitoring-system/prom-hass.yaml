apiVersion: ricoberger.de/v1alpha1
kind: VaultSecret
metadata:
  name: beryjuorg-prom-additional-scrape-creds-hass
  namespace: monitoring-system
spec:
  path: kv/services/prometheus/home-assistant
  type: Opaque
  templates:
    PW_HOME_ASSISTANT: "{% .Secrets.metrics_jwt %}"
---
kind: Service
apiVersion: v1
metadata:
  name: beryjuorg-prom-hass
  labels:
    svc: beryjuorg-prom-hass
  namespace: monitoring-system
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 8123
      targetPort: 8123
---
kind: Endpoints
apiVersion: v1
metadata:
  name: beryjuorg-prom-hass
  namespace: monitoring-system
subsets:
  - addresses:
      - ip: 10.120.20.60
    ports:
      - name: http
        port: 8123
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: beryjuorg-prom-hass
  namespace: monitoring-system
spec:
  endpoints:
    - interval: 30s
      port: http
      path: "/api/prometheus"
      bearerTokenSecret:
        name: beryjuorg-prom-additional-scrape-creds-hass
        key: PW_HOME_ASSISTANT
  selector:
    matchLabels:
      svc: beryjuorg-prom-hass
