apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mongodb
  namespace: unifi-controller
spec:
  chart:
    spec:
      chart: mongodb
      version: 15.6.26
      sourceRef:
        kind: HelmRepository
        name: bitnami
        namespace: flux-system
  interval: 1h0m0s
  valuesFrom:
    - kind: Secret
      name: beryjuio-mongo
  values:
    architecture: standalone
    metrics:
      enabled: true
      serviceMonitor:
        enabled: true
      prometheusRule:
        enabled: true
    resourcesPreset: "none"
    initdbScripts:
      unifi.sh: |
        #!/bin/bash

        if which mongosh > /dev/null 2>&1; then
          mongo_init_bin='mongosh'
        else
          mongo_init_bin='mongo'
        fi
        "${mongo_init_bin}" <<EOF
        use admin
        db.auth("${MONGODB_ROOT_USER}", "${MONGODB_ROOT_PASSWORD}")
        db.createUser({
          user: "${MONGODB_EXTRA_USERNAMES}",
          pwd: "${MONGODB_EXTRA_PASSWORDS}",
          roles: [
            { db: "${MONGODB_EXTRA_DATABASES}", role: "dbOwner" },
            { db: "${MONGODB_EXTRA_DATABASES}_stat", role: "dbOwner" }
          ]
        })
        EOF

