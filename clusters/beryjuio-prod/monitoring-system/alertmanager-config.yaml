apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: beryjuio-alertmanager
  namespace: monitoring-system
spec:
  global:
    resolve_timeout: 5m
    slack_api_url_file: "/etc/alertmanager/secrets/discord_url"
  inhibit_rules:
  - equal:
    - alertname
    - namespace
    source_match:
      severity: critical
    target_match:
      severity: warning
  receivers:
  - name: "null"
  - name: discord
    slack_configs:
    - channel: '#prometheus'
      icon_url: https://images.s3.beryju.org/prometheus.png
      send_resolved: true
      text: |-
        {{ range .Alerts -}}

          **Alert:** {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}
        **Description:** {{ if ne .Annotations.description ""}}{{ printf "%.400s" .Annotations.description }}{{else}}N/A{{ end }} **Details:**

          {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
          {{ end }}
        {{ end }}
      title: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing
        | len }}{{ end }}] {{ if ne .CommonAnnotations.summary ""}}{{ .CommonAnnotations.summary
        }}{{ else }}{{ .CommonLabels.alertname }}{{ end }}'
      username: Prometheus
  route:
    group_by:
    - alertname
    - job
    group_interval: 5m
    group_wait: 30s
    receiver: discord
    repeat_interval: 6h
    routes:
    - match:
        alertname: Watchdog
      receiver: "null"
    - continue: true
      match_re:
        severity: critical
      receiver: discord
  templates:
  - /etc/alertmanager/config/*.tmpl
