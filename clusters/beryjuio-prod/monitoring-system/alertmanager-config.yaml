apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: beryjuio-alertmanager
  namespace: monitoring-system
spec:
  receivers:
    - name: "null"
    - name: discord
      discordConfigs:
        - apiURL:
            name: beryjuio-alertmanager-discord
            key: discord_url
          sendResolved: true
          title:
            '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing
            | len }}{{ end }}] {{ if ne .CommonAnnotations.summary ""}}{{ .CommonAnnotations.summary
            }}{{ else }}{{ .CommonLabels.alertname }}{{ end }}'
          message: |-
            {{ range .Alerts -}}

            **Alert:** {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}
            **Description:** {{ if ne .Annotations.description ""}}{{ printf "%.400s" .Annotations.description }}{{ else }}N/A{{ end }}

            **Details:**
              {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
              {{ end }}
            {{ end }}
          username: Prometheus
  route:
    groupBy:
      - alertname
      - cluster
    groupInterval: 5m
    groupWait: 30s
    receiver: discord
    repeatInterval: 6h
    routes:
      - matchers:
          - name: alertname
            value: Watchdog
        receiver: null
      - matchers:
          - name: severity
            matchType: "=~"
            value: critical
        receiver: discord
