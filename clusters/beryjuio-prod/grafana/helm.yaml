apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: grafana
  namespace: grafana
spec:
  timeout: 30m
  interval: 6h
  chart:
    spec:
      chart: grafana
      version: 6.58.1
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  values:
    image:
      repository: proxy.registry.beryju.org/grafana/grafana
    resources:
      limits:
        memory: 750Mi
      requests:
        memory: 500Mi
    ingress:
      enabled: true
      hosts:
        - grafana.infra.beryju.org
      tls:
        - secretName: beryjuorg-authentik-proxy-infra
          hosts:
            - grafana.infra.beryju.org
    serviceMonitor:
      enabled: true
    persistence:
      enabled: true
    deploymentStrategy:
      type: Recreate
    envFromSecret: grafana-secrets
    env:
      GF_SERVER_DOMAIN: "grafana.infra.beryju.org"
      GF_SERVER_ROOT_URL: "https://grafana.infra.beryju.org/"
      GF_PLUGINS_ENABLE_ALPHA: "true"
      GF_AUTH_GENERIC_OAUTH_ENABLED: "true"
      GF_AUTH_GENERIC_OAUTH_NAME: "authentik"
      GF_AUTH_GENERIC_OAUTH_SCOPES: "openid profile email"
      GF_AUTH_GENERIC_OAUTH_AUTH_URL: "https://id.beryju.org/application/o/authorize/"
      GF_AUTH_GENERIC_OAUTH_TOKEN_URL: "https://id.beryju.org/application/o/token/"
      GF_AUTH_GENERIC_OAUTH_API_URL: "https://id.beryju.org/application/o/userinfo/"
      GF_AUTH_SIGNOUT_REDIRECT_URL: "https://id.beryju.org/application/o/grafana/end-session/"
      # GF_AUTH_OAUTH_AUTO_LOGIN: "true"
      GF_LOG_CONSOLE_FORMAT: "json"
      GF_FEATURE_TOGGLES_ENABLE: flameGraph
